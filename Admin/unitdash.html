<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Easy Rent - Admin Panel</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #2563eb;
        --secondary-color: #4f46e5;
        --background: #f8fafc;
        --card-bg: #ffffff;
        --light-color: #f0f7ff;
        --dark-color: #0f172a;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --gray-color: #64748b;
        --border-radius: 12px;
        --shadow: 0 6px 12px rgba(0, 0, 0, 0.05);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --gradient: linear-gradient(135deg, #4f46e5, #2563eb);
      }

      /* Student Cards */
      .student-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 16px;
        transition: var(--transition);
        border-left: 4px solid var(--primary-color);
        margin-bottom: 16px;
      }

      .student-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .student-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e2e8f0;
      }

      .student-card .card-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
      }

      .student-card .status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: capitalize;
      }

      .student-card .status-active {
        background-color: #d1fae5;
        color: #065f46;
      }

      .student-card .status-inactive {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .student-card .card-details {
        display: grid;
        gap: 8px;
        font-size: 14px;
        color: var(--dark-color);
      }

      .student-card .card-details span {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .student-card .card-details i {
        color: var(--primary-color);
        width: 16px;
        text-align: center;
      }

      .student-card .card-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        justify-content: flex-end;
      }

      /* Student Details Modal */
      #studentDetailsModal .modal-content {
        max-width: 600px;
      }

      #studentDetailsModal .modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      #studentDetailsModal .detail-item {
        margin-bottom: 12px;
      }

      #studentDetailsModal .detail-item strong {
        display: block;
        font-size: 12px;
        color: var(--gray-color);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      #studentDetailsModal .detail-item span {
        font-size: 14px;
        font-weight: 500;
        color: var(--dark-color);
        word-break: break-word;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .student-card .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .student-card .card-header h3 {
          max-width: 100%;
        }

        #studentDetailsModal .modal-body {
          grid-template-columns: 1fr;
        }

        .student-card .card-actions {
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <!-- Students Management Section -->
    <section id="students" class="content-section">
      <div class="header">
        <div class="page-title">
          <h1>Students Management</h1>
        </div>
        <div class="controls">
          <input
            type="text"
            class="search-input"
            placeholder="Search students..."
            id="studentSearch"
          />
          <button
            class="btn btn-primary"
            onclick="fetchStudents()"
            data-tooltip="Refresh Data"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <h2>Total Students</h2>
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
          </div>
          <div class="stat-value" id="totalStudentsCount">0</div>
          <div class="stat-change">
            <i class="fas fa-sync-alt fa-spin"></i> Loading...
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <h2>Active Students</h2>
            <div class="stat-icon">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          <div class="stat-value" id="activeStudentsCount">0</div>
          <div class="stat-change">
            <i class="fas fa-sync-alt fa-spin"></i> Loading...
          </div>
        </div>
      </div>

      <div class="card-grid" id="studentsTable">
        <div class="no-data">
          <i class="material-icons">info</i>
          No students found. Click refresh to load data.
        </div>
      </div>
    </section>

    <!-- Student Details Modal -->
    <div class="modal" id="studentDetailsModal">
      <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">Ã—</button>
        <h2>Student Details</h2>
        <div class="modal-body">
          <div class="detail-item">
            <strong>Username:</strong>
            <span id="studentDetailsUsername"></span>
          </div>
          <div class="detail-item">
            <strong>Email:</strong>
            <span id="studentDetailsEmail"></span>
          </div>
          <div class="detail-item">
            <strong>Phone:</strong>
            <span id="studentDetailsPhone"></span>
          </div>
          <div class="detail-item">
            <strong>Address:</strong>
            <span id="studentDetailsAddress"></span>
          </div>
          <div class="detail-item">
            <strong>University:</strong>
            <span id="studentDetailsUniversity"></span>
          </div>
          <div class="detail-item">
            <strong>College:</strong>
            <span id="studentDetailsCollege"></span>
          </div>
        </div>
        <div class="form-actions">
          <button
            class="btn btn-danger"
            id="deleteStudentBtn"
            data-tooltip="Delete Student"
          >
            <i class="fas fa-trash"></i> Delete
          </button>
          <button class="btn" onclick="closeModal()">Close</button>
        </div>
      </div>
    </div>

    <script>
      // Student Management API Functions
      const studentAPI = {
        baseUrl: "https://easyrentapi0.runasp.net/api/Student",

        // Fetch all students
        getAllStudents: async () => {
          try {
            const response = await fetch(`${studentAPI.baseUrl}/all-students`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("authToken")}`,
              },
            });
            if (!response.ok) throw new Error("Failed to fetch students");
            const data = await response.json();
            return data?.$values || [];
          } catch (error) {
            console.error("Error fetching students:", error);
            throw error;
          }
        },

        // Get single student by ID
        getStudentById: async (id) => {
          try {
            const response = await fetch(`${studentAPI.baseUrl}/${id}`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("authToken")}`,
              },
            });
            if (!response.ok) throw new Error("Failed to fetch student");
            return await response.json();
          } catch (error) {
            console.error("Error fetching student:", error);
            throw error;
          }
        },

        // Delete student
        deleteStudent: async (id) => {
          try {
            const response = await fetch(`${studentAPI.baseUrl}/${id}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("authToken")}`,
              },
            });
            if (!response.ok) throw new Error("Failed to delete student");
            return true;
          } catch (error) {
            console.error("Error deleting student:", error);
            throw error;
          }
        },

        // Search students
        searchStudents: async (query) => {
          try {
            const response = await fetch(
              `${studentAPI.baseUrl}/search?q=${encodeURIComponent(query)}`,
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("authToken")}`,
                },
              }
            );
            if (!response.ok) throw new Error("Failed to search students");
            const data = await response.json();
            return data?.$values || [];
          } catch (error) {
            console.error("Error searching students:", error);
            throw error;
          }
        },
      };

      // Student Management UI Functions
      const studentUI = {
        // Render students list
        renderStudents: (students) => {
          const container = document.getElementById("studentsTable");
          if (!students || students.length === 0) {
            container.innerHTML = `
              <div class="no-data">
                <i class="material-icons">info</i>
                No students found
              </div>
            `;
            return;
          }

          container.innerHTML = students
            .map(
              (student) => `
            <div class="student-card" data-student-id="${student.id}">
              <div class="card-header">
                <h3>${
                  student.username || student.email || "Unnamed Student"
                }</h3>
                <span class="status status-${
                  student.status?.toLowerCase() || "active"
                }">
                  ${student.status || "Active"}
                </span>
              </div>
              <div class="card-details">
                <span><i class="fas fa-envelope"></i> ${
                  student.email || "No email"
                }</span>
                <span><i class="fas fa-phone"></i> ${
                  student.phone || "No phone"
                }</span>
                <span><i class="fas fa-map-marker-alt"></i> ${
                  student.address || "No address"
                }</span>
                <span><i class="fas fa-university"></i> ${
                  student.university || "No university"
                }</span>
              </div>
              <div class="card-actions">
                <button class="btn btn-primary btn-sm view-btn" data-student-id="${
                  student.id
                }">
                  <i class="fas fa-eye"></i> View
                </button>
                <button class="btn btn-danger btn-sm delete-btn" data-student-id="${
                  student.id
                }">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Update stats
          studentUI.updateStudentStats(students);
        },

        // Update student statistics
        updateStudentStats: (students) => {
          document.getElementById("totalStudentsCount").textContent =
            students.length;
          document.getElementById("activeStudentsCount").textContent =
            students.filter(
              (s) => !s.status || s.status.toLowerCase() === "active"
            ).length;

          document.querySelectorAll(".stat-change").forEach((el) => {
            el.innerHTML = `<i class="fas fa-check"></i> Updated`;
          });
        },

        // Show student details in modal
        showStudentDetails: (student) => {
          document.getElementById("studentDetailsUsername").textContent =
            student.username || "N/A";
          document.getElementById("studentDetailsEmail").textContent =
            student.email || "N/A";
          document.getElementById("studentDetailsPhone").textContent =
            student.phone || "N/A";
          document.getElementById("studentDetailsAddress").textContent =
            student.address || "N/A";
          document.getElementById("studentDetailsUniversity").textContent =
            student.university || "N/A";
          document.getElementById("studentDetailsCollege").textContent =
            student.college || "N/A";

          // Set current student ID for actions
          document.getElementById("deleteStudentBtn").dataset.studentId =
            student.id;

          // Show modal
          document.getElementById("studentDetailsModal").classList.add("show");
        },

        // Show loading state
        showLoading: (elementId, message = "Loading...") => {
          const container = document.getElementById(elementId);
          if (container) {
            container.innerHTML = `
              <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i> ${message}</div>
            `;
          }
        },

        // Show error message
        showError: (elementId, message) => {
          const container = document.getElementById(elementId);
          if (container) {
            container.innerHTML = `
              <div class="no-data">
                <i class="material-icons">error</i>
                ${message}
              </div>
            `;
          }
        },
      };

      // Student Event Handlers
      const studentHandlers = {
        // Initialize student section
        init: () => {
          // Load students when section is shown
          document
            .querySelector('.nav-item[data-target="students"]')
            ?.addEventListener("click", () => {
              studentHandlers.loadStudents();
            });

          // Search functionality
          document
            .getElementById("studentSearch")
            ?.addEventListener("input", (e) => {
              const query = e.target.value.trim();
              if (query.length > 2) {
                studentHandlers.searchStudents(query);
              } else if (query.length === 0) {
                studentHandlers.loadStudents();
              }
            });

          // Delete student button
          document
            .getElementById("deleteStudentBtn")
            ?.addEventListener("click", async () => {
              const studentId =
                document.getElementById("deleteStudentBtn").dataset.studentId;
              if (studentId) {
                await studentHandlers.deleteStudent(studentId);
              }
            });

          // Event delegation for student cards
          document
            .getElementById("studentsTable")
            ?.addEventListener("click", (e) => {
              const viewBtn = e.target.closest(".view-btn");
              const deleteBtn = e.target.closest(".delete-btn");

              if (viewBtn) {
                const studentId = viewBtn.dataset.studentId;
                studentHandlers.viewStudent(studentId);
              } else if (deleteBtn) {
                const studentId = deleteBtn.dataset.studentId;
                studentHandlers.confirmDeleteStudent(studentId);
              }
            });

          // Load students if section is active
          if (
            document.getElementById("students")?.classList.contains("active")
          ) {
            studentHandlers.loadStudents();
          }
        },

        // Load all students
        loadStudents: async () => {
          try {
            studentUI.showLoading("studentsTable", "Loading students...");
            const students = await studentAPI.getAllStudents();
            studentUI.renderStudents(students);
          } catch (error) {
            studentUI.showError(
              "studentsTable",
              "Failed to load students. Please try again."
            );
            console.error("Error loading students:", error);
          }
        },

        // Search students
        searchStudents: async (query) => {
          try {
            studentUI.showLoading("studentsTable", "Searching students...");
            const students = await studentAPI.searchStudents(query);
            studentUI.renderStudents(students);
          } catch (error) {
            studentUI.showError(
              "studentsTable",
              "Search failed. Please try again."
            );
            console.error("Error searching students:", error);
          }
        },

        // View single student
        viewStudent: async (studentId) => {
          try {
            const student = await studentAPI.getStudentById(studentId);
            studentUI.showStudentDetails(student);
          } catch (error) {
            showNotification("Failed to load student details", false);
            console.error("Error viewing student:", error);
          }
        },

        // Confirm and delete student
        confirmDeleteStudent: async (studentId) => {
          if (
            confirm(
              "Are you sure you want to delete this student? This action cannot be undone."
            )
          ) {
            await studentHandlers.deleteStudent(studentId);
          }
        },

        // Delete student
        deleteStudent: async (studentId) => {
          try {
            studentUI.showLoading("studentsTable", "Deleting student...");
            await studentAPI.deleteStudent(studentId);
            showNotification("Student deleted successfully", true);
            closeModal();
            await studentHandlers.loadStudents();
          } catch (error) {
            showNotification("Failed to delete student", false);
            console.error("Error deleting student:", error);
          }
        },
      };

      // Initialize student management when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        studentHandlers.init();
      });

      // Helper function to show notifications
      function showNotification(message, isSuccess) {
        const notification = document.createElement("div");
        notification.className = `notification ${
          isSuccess ? "success" : "error"
        }`;
        notification.innerHTML = `
          <i class="fas fa-${
            isSuccess ? "check-circle" : "exclamation-circle"
          }"></i>
          ${message}
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add("show");
          setTimeout(() => {
            notification.classList.remove("show");
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }, 10);
      }

      // Helper function to close modals
      function closeModal() {
        document.querySelectorAll(".modal").forEach((modal) => {
          modal.classList.remove("show");
        });
      }

      // Expose fetchStudents to global scope for button onclick
      window.fetchStudents = studentHandlers.loadStudents;
    </script>
  </body>
</html>
